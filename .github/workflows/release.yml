name: Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Fetch all history for proper changelog generation
    
    - name: Fetch tag annotations
      shell: pwsh
      run: |
        # Explicitly fetch tag annotations (full tag objects, not just refs)
        git fetch --depth=1 origin +refs/tags/*:refs/tags/*
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '9.0.x'
        
    - name: Restore dependencies
      run: dotnet restore sign.sln
      
    - name: Run tests
      run: dotnet test sign.sln --verbosity normal
      
    - name: Publish Release
      run: dotnet publish PdfSigner.csproj -c Release
      
    - name: Get version info
      id: version
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}"
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        
        # Get executable info
        $exePath = "bin/Release/net9.0/win-x64/publish/PdfSigner.exe"
        $size = [math]::Round((Get-Item $exePath).Length / 1MB, 2)
        echo "SIZE=$size MB" >> $env:GITHUB_OUTPUT
        
        $hash = (Get-FileHash $exePath -Algorithm SHA256).Hash
        echo "SHA256=$hash" >> $env:GITHUB_OUTPUT
        
    - name: Create ZIP archive
      shell: pwsh
      run: |
        $archiveName = "PdfSigner-${{ steps.version.outputs.VERSION }}-win-x64.zip"
        Compress-Archive -Path "bin/Release/net9.0/win-x64/publish/PdfSigner.exe" -DestinationPath $archiveName
        echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_OUTPUT
        
    - name: Generate release notes
      id: notes
      shell: pwsh
      run: |
        # Get tag annotation message (returns array of lines)
        $tagMessage = git tag -l --format='%(contents)' ${{ steps.version.outputs.VERSION }}
        
        # If tag has annotation, use it; otherwise provide minimal note
        if ($tagMessage -and $tagMessage.Count -gt 0) {
          # Join array lines with newlines to create full message
          $fullMessage = $tagMessage -join "`n"
          $notes = @"
        $fullMessage
        
        See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for documentation.
        "@
        } else {
          $notes = @"
        Release ${{ steps.version.outputs.VERSION }}
        
        See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for documentation.
        "@
        }
        
        $notes | Out-File -FilePath release-notes.md -Encoding utf8
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: PDF Signer ${{ steps.version.outputs.VERSION }}
        body_path: release-notes.md
        files: |
          PdfSigner-${{ steps.version.outputs.VERSION }}-win-x64.zip
          bin/Release/net9.0/win-x64/publish/PdfSigner.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
